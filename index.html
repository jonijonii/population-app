<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울시 생활인구 조회</title>
    <!-- 1. 도구 장착: Supabase와 Chart.js 라이브러리를 불러옵니다. -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 간단한 스타일 추가 */
        body { font-family: sans-serif; margin: 2em; }
        #input-section { margin-bottom: 1em; }
        input, button { padding: 8px; margin-right: 10px; }
    </style>
</head>
<body>

    <h1>서울시 생활인구 시간대별 조회</h1>

    <div id="input-section">
        <label for="dongCode">행정동코드:</label>
        <input type="text" id="dongCode" placeholder="예: 1144066000">

        <label for="searchDate">날짜:</label>
        <input type="date" id="searchDate">

        <button id="searchButton">조회</button>
    </div>

    <p id="warningMessage" style="color: red;"></p>

    <div id="chart-container" style="width: 80%; max-width: 900px; margin-top: 20px;">
        <canvas id="populationChart"></canvas>
    </div>

    <script>
        // --- Supabase 프로젝트 정보 입력 ---
        const supabaseUrl = 'YOUR_SUPABASE_URL'; 
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- HTML 요소들을 JavaScript 변수에 연결 ---
        const dongCodeInput = document.getElementById('dongCode');
        const dateInput = document.getElementById('searchDate');
        const searchButton = document.getElementById('searchButton');
        const warningMessage = document.getElementById('warningMessage');
        const chartCanvas = document.getElementById('populationChart');
        let populationChart; 

        // --- '조회' 버튼 클릭 시 실행될 기능 정의 ---
        searchButton.addEventListener('click', async () => {
            const dongCodeString = dongCodeInput.value;
            const searchDate = dateInput.value;

            // 1. 입력값 유효성 검사
            if (!dongCodeString || !searchDate) {
                warningMessage.textContent = "올바른 값을 입력해주세요.";
                return; 
            }
            warningMessage.textContent = "";

            const dongCode = parseInt(dongCodeString, 10);
            
            // --- [디버깅] ---
            // Supabase에 요청하기 직전의 값을 개발자 콘솔에 출력해봅니다.
            console.log("--- Supabase에 보내는 요청 값 ---");
            console.log("행정동코드 (타입: " + typeof dongCode + "):", dongCode);
            console.log("날짜 (타입: " + typeof searchDate + "):", searchDate);
            // --- [디버깅 끝] ---

            // 2. Supabase에서 데이터 조회
            const { data, error } = await supabaseClient
                .from('seoul_data') 
                .select('시간대, 총생활인구수')
                .eq('행정동코드', dongCode)
                .eq('날짜', searchDate)      
                .order('시간대', { ascending: true }); 

            // --- [디버깅] ---
            // Supabase로부터 받은 응답을 콘솔에 출력해봅니다.
            console.log("\n--- Supabase로부터 받은 응답 ---");
            console.log("Data:", data);
            console.log("Error:", error);
            // --- [디버깅 끝] ---

            if (error) {
                warningMessage.textContent = `데이터 조회 중 오류 발생: ${error.message}`;
                return;
            }

            if (data.length === 0) {
                warningMessage.textContent = "해당 조건의 데이터가 없습니다.";
                if (populationChart) {
                    populationChart.destroy();
                }
                return;
            }

            // 3. Chart.js 그래프 생성
            const labels = data.map(item => `${item.시간대}시`);
            const chartData = data.map(item => item.총생활인구수);

            if (populationChart) {
                populationChart.destroy();
            }

            populationChart = new Chart(chartCanvas, {
                type: 'line', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${searchDate} 총생활인구수`,
                        data: chartData,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                }
            });
        });
    </script>
</body>
</html>

