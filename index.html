<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울시 생활인구 조회</title>
    <!-- 1. 도구 장착: Supabase와 Chart.js 라이브러리를 불러옵니다. -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 간단한 스타일 추가 */
        body { font-family: sans-serif; margin: 2em; }
        #input-section { margin-bottom: 1em; }
        input, button { padding: 8px; margin-right: 10px; }
    </style>
</head>
<body>

    <h1>서울시 생활인구 시간대별 조회</h1>

    <!-- 사용자 입력을 받는 구역 (변경 없음) -->
    <div id="input-section">
        <label for="dongCode">행정동코드:</label>
        <input type="text" id="dongCode" placeholder="예: 1144066000">

        <label for="searchDate">날짜:</label>
        <input type="date" id="searchDate">

        <button id="searchButton">조회</button>
    </div>

    <!-- 경고 메시지를 보여줄 구역 (변경 없음) -->
    <p id="warningMessage" style="color: red;"></p>

    <!-- 그래프가 그려질 텅 빈 캔버스 구역 (변경 없음) -->
    <div id="chart-container" style="width: 80%; max-width: 900px; margin-top: 20px;">
        <canvas id="populationChart"></canvas>
    </div>

    <!-- 2. 스마트 시스템 설치: JavaScript 코드 -->
    <script>
        // --- Supabase 프로젝트 정보 입력 ---
        // 이 부분은 본인의 Supabase 프로젝트 URL과 anon key로 반드시 교체해야 합니다.
        const supabaseUrl = 'https://tjjxnvjzoxhjknungpen.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqanhudmp6b3hoamtudW5ncGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNTYxNjcsImV4cCI6MjA3MzkzMjE2N30.9eUrs1-6xUU2z2w6oEyC45wDOjL_1tgtuDGIkSw5SIQ';
        // [FIX] 변수 이름 충돌을 피하기 위해 'supabase'를 'supabaseClient'로 변경
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- HTML 요소들을 JavaScript 변수에 연결 ---
        const dongCodeInput = document.getElementById('dongCode');
        const dateInput = document.getElementById('searchDate');
        const searchButton = document.getElementById('searchButton');
        const warningMessage = document.getElementById('warningMessage');
        const chartCanvas = document.getElementById('populationChart');
        let populationChart; // 차트 객체를 저장할 변수

        // ---'조회' 버튼 클릭 시 실행될 기능 정의 ---
        searchButton.addEventListener('click', async () => {
            // [FIX] 입력받은 행정동코드를 글자(string)에서 숫자(integer)로 변환합니다.
            const dongCode = parseInt(dongCodeInput.value, 10);
            const searchDate = dateInput.value;

            // 1. 입력값 유효성 검사
            if (!dongCode || !searchDate) {
                warningMessage.textContent = "올바른 값을 입력해주세요.";
                return; // 함수 종료
            }
            warningMessage.textContent = ""; // 유효하면 경고 메시지 삭제

            // 2. Supabase에서 데이터 조회
            // [FIX] 수정한 변수 이름 'supabaseClient'를 사용하여 데이터 조회
            const { data, error } = await supabaseClient
                .from('numpeople') // 테이블 이름
                .select('시간대, 총생활인구수') // 필요한 컬럼 선택
                .eq('행정동코드', dongCode)    // 조건 1: 행정동코드 일치
                .eq('날짜', searchDate)      // 조건 2: 날짜 일치
                .order('시간대', { ascending: true }); // 시간순으로 정렬

            if (error) {
                warningMessage.textContent = `데이터 조회 중 오류 발생: ${error.message}`;
                return;
            }

            if (data.length === 0) {
                warningMessage.textContent = "해당 조건의 데이터가 없습니다.";
                // 이전 차트가 있다면 지웁니다.
                if (populationChart) {
                    populationChart.destroy();
                }
                return;
            }

            // 3. Chart.js 그래프 생성
            const labels = data.map(item => `${item.시간대}시`);
            const chartData = data.map(item => item.총생활인구수);

            // 이전에 그려진 차트가 있다면 파괴하고 새로 그립니다.
            if (populationChart) {
                populationChart.destroy();
            }

            populationChart = new Chart(chartCanvas, {
                type: 'line', // 꺾은선 그래프
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${searchDate} 총생활인구수`,
                        data: chartData,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                }
            });
        });
    </script>
</body>
</html>

